<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Poker Demo Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Упрощённое подключение socket.io, без integrity -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #111;
      color: #eee;
    }
    .card {
      max-width: 640px;
      margin: 0 auto;
      padding: 16px;
      background: #1b1b1b;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    }
    h1 {
      font-size: 20px;
      margin-top: 0;
    }
    label, input, button {
      font-size: 14px;
    }
    input {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #000;
      color: #eee;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #2d8cff;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    button:disabled {
      background: #555;
      cursor: default;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .table-info, .players, .you, .messages {
      margin-top: 12px;
      padding: 8px;
      background: #111;
      border-radius: 8px;
      font-size: 13px;
    }
    .players-list {
      margin-top: 4px;
    }
    .player-row {
      display: flex;
      flex-direction: column;
      padding: 4px 0;
      border-bottom: 1px solid #222;
    }
    .player-row:last-child {
      border-bottom: none;
    }
    .player-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }
    small {
      color: #888;
    }
    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #222;
      margin-right: 4px;
      font-size: 12px;
    }
    .pill-btn {
      border: 1px solid #555;
    }
    .error {
      color: #ff6b6b;
      margin-top: 4px;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .hint {
      margin-top: 4px;
      font-size: 12px;
      color: #ccc;
    }
    .your-message {
      margin-top: 4px;
      font-size: 12px;
      color: #9ae6b4;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Poker Demo Table</h1>
    <p><small>Демо одного стола: подключение игроков, раздача карт, банк, стадии раздачи, пауза.</small></p>

    <label for="name">Ваш ник:</label>
    <input id="name" type="text" placeholder="Player" />

    <div class="row">
      <button id="joinBtn">Подключиться</button>
      <button id="leaveBtn" disabled>Отключиться</button>
      <button id="playPauseBtn" disabled>Пауза</button>
    </div>

    <div class="row">
      <button id="startBtn" disabled>Начать раздачу</button>
      <button id="nextBtn" style="display:none;" disabled>Следующая стадия</button>
    </div>

    <div class="row">
      <button id="foldBtn" disabled>Фолд</button>
      <button id="callBtn" disabled>Чек / Колл</button>
      <button id="betBtn" disabled>Бет / Рейз 10</button>
    </div>

    <div id="errorBox" class="error"></div>
    <div id="hintBox" class="hint"></div>

    <div class="table-info">
      <div><strong>Стадия:</strong> <span id="stage">waiting</span></div>
      <div><strong>Событие:</strong> <span id="tableMessage">—</span></div>
      <div><strong>Общий банк (пред. улицы):</strong> <span id="mainPot">0</span> фишек</div>
      <div><strong>Банк текущей улицы:</strong> <span id="streetPot">0</span> фишек</div>
      <div><strong>Суммарный банк:</strong> <span id="totalPot">0</span> фишек</div>
      <div><strong>Блайнды:</strong> <span id="blinds">10 / 20</span></div>
      <div><strong>Текущая ставка раунда:</strong> <span id="currentBet">0</span></div>
      <div><strong>Ход игрока:</strong> <span id="currentTurn">—</span></div>
      <div style="margin-top:4px;">
        <strong>Борд:</strong>
        <span id="boardCards"><small>—</small></span>
      </div>
    </div>

    <div class="you">
      <strong>Ваши карты:</strong>
      <div id="yourCards"><small>—</small></div>
      <div><strong>Ваш стек:</strong> <span id="yourStack">—</span></div>
      <div><strong>Таймер хода:</strong> <span id="turnTimer">—</span></div>
      <div class="your-message" id="yourMessage"></div>
    </div>

    <div class="players">
      <strong>Игроки за столом:</strong>
      <div id="playersList" class="players-list">
        <small>Нет подключений.</small>
      </div>
    </div>

    <div class="messages">
      <small>Логи сервера доступны по <code>/log</code> (для отладки).</small>
    </div>
  </div>

  <script>
    // Поймаем любые ошибки JS и покажем их в errorBox
    window.onerror = function(msg, url, line, col, err) {
      const box = document.getElementById('errorBox');
      box.textContent = 'JS error: ' + msg + ' @ ' + line + ':' + col;
    };

    console.log('Client script loaded');

    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const foldBtn = document.getElementById('foldBtn');
    const callBtn = document.getElementById('callBtn');
    const betBtn = document.getElementById('betBtn');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const nameInput = document.getElementById('name');

    const errorBox = document.getElementById('errorBox');
    const hintBox = document.getElementById('hintBox');

    const stageSpan = document.getElementById('stage');
    const tableMessageSpan = document.getElementById('tableMessage');
    const mainPotSpan = document.getElementById('mainPot');
    const streetPotSpan = document.getElementById('streetPot');
    const totalPotSpan = document.getElementById('totalPot');
    const blindsSpan = document.getElementById('blinds');
    const currentBetSpan = document.getElementById('currentBet');
    const currentTurnSpan = document.getElementById('currentTurn');
    const boardCardsSpan = document.getElementById('boardCards');
    const yourCardsDiv = document.getElementById('yourCards');
    const yourStackSpan = document.getElementById('yourStack');
    const yourMessageDiv = document.getElementById('yourMessage');
    const playersList = document.getElementById('playersList');
    const turnTimerSpan = document.getElementById('turnTimer');

    let lastState = null;
    let turnCountdownInterval = null;

    function stopTurnCountdown() {
      if (turnCountdownInterval) {
        clearInterval(turnCountdownInterval);
        turnCountdownInterval = null;
      }
      if (turnTimerSpan) {
        turnTimerSpan.textContent = '—';
      }
    }

    function startTurnCountdown(deadline) {
      stopTurnCountdown();
      if (!deadline || !turnTimerSpan) return;

      function tick() {
        const msLeft = deadline - Date.now();
        if (msLeft <= 0) {
          turnTimerSpan.textContent = '0 c';
          stopTurnCountdown();
          return;
        }
        const seconds = Math.ceil(msLeft / 1000);
        turnTimerSpan.textContent = seconds + ' c';
      }

      tick();
      turnCountdownInterval = setInterval(tick, 500);
    }

    if (typeof io === 'undefined') {
      errorBox.textContent = 'Ошибка: socket.io клиент не загрузился (io is undefined).';
    }

    const socket = (typeof io !== 'undefined') ? io() : null;

    if (socket) {
      socket.on('connect', () => {
        console.log('Connected, id=', socket.id);
        errorBox.textContent = '';
      });

      socket.on('disconnect', () => {
        console.log('Disconnected');
        joinBtn.disabled = false;
        leaveBtn.disabled = true;
        startBtn.disabled = true;
        nextBtn.disabled = true;
        foldBtn.disabled = true;
        callBtn.disabled = true;
        betBtn.disabled = true;
        playPauseBtn.disabled = true;
        hintBox.textContent = '';
        stopTurnCountdown();
      });

      socket.on('gameState', (state) => {
        console.log('gameState:', state);
        lastState = state;
        renderState(state);
      });

      socket.on('errorMessage', (data) => {
        if (data && data.message) {
          errorBox.textContent = data.message;
        }
      });
    }

    // ===== Обработчики кнопок =====

    joinBtn.addEventListener('click', () => {
      console.log('joinBtn clicked');
      if (!socket) {
        errorBox.textContent = 'Нет соединения с сервером (socket не инициализирован).';
        return;
      }
      const name = nameInput.value.trim() || 'Player';
      errorBox.textContent = '';
      socket.connect();
      socket.emit('joinTable', { playerName: name });
      joinBtn.disabled = true;
      leaveBtn.disabled = false;
    });

    leaveBtn.addEventListener('click', () => {
      console.log('leave click');
      errorBox.textContent = '';
      if (socket) socket.disconnect();
    });

    startBtn.addEventListener('click', () => {
      console.log('startHand click');
      errorBox.textContent = '';
      if (socket) socket.emit('startHand');
    });

    nextBtn.addEventListener('click', () => {
      console.log('nextStage click');
      errorBox.textContent = '';
      if (socket) socket.emit('nextStage');
    });

    foldBtn.addEventListener('click', () => {
      if (!lastState) return;
      console.log('fold click');
      errorBox.textContent = '';
      if (socket) socket.emit('action', { type: 'fold' });
    });

    callBtn.addEventListener('click', () => {
      if (!lastState) return;
      console.log('call/check click');
      errorBox.textContent = '';
      if (socket) socket.emit('action', { type: 'call' });
    });

    betBtn.addEventListener('click', () => {
      if (!lastState) return;
      console.log('bet/raise click');
      errorBox.textContent = '';
      if (socket) socket.emit('action', { type: 'bet' });
    });

    playPauseBtn.addEventListener('click', () => {
      if (!lastState || !socket) return;
      const me = (lastState.players || []).find(p => p.id === socket.id);
      if (!me) return;
      const wantPlay = me.isPaused; // если сейчас на паузе — хотим играть
      socket.emit('setPlaying', { playing: wantPlay });
    });

    // ===== Рендер состояния =====

    function renderState(state) {
      if (!state) return;

      stageSpan.textContent = state.stage || 'waiting';
      tableMessageSpan.textContent = state.tableMessage || '—';

      mainPotSpan.textContent = state.mainPot != null ? state.mainPot : 0;
      streetPotSpan.textContent = state.streetPot != null ? state.streetPot : 0;
      totalPotSpan.textContent = state.totalPot != null ? state.totalPot : 0;
      blindsSpan.textContent = (state.smallBlind || 0) + ' / ' + (state.bigBlind || 0);
      currentBetSpan.textContent = state.currentBet != null ? state.currentBet : 0;

      if (state.stage === 'waiting') {
        const activeCount = (state.players || []).filter(p => !p.isPaused && p.stack > 0).length;
        if (activeCount >= 2) {
          startBtn.style.display = 'inline-block';
          startBtn.disabled = false;
        } else {
          startBtn.style.display = 'inline-block';
          startBtn.disabled = true;
        }
        nextBtn.style.display = 'none';
      } else {
        startBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      }

      let currentPlayerName = null;
      if (state.currentTurn && state.players) {
        const current = state.players.find(p => p.id === state.currentTurn);
        if (current) {
          currentPlayerName = current.name || current.id;
        }
        currentTurnSpan.textContent = currentPlayerName || '—';
      } else {
        currentTurnSpan.textContent = '—';
      }

      if (state.communityCards && state.communityCards.length > 0) {
        boardCardsSpan.innerHTML = state.communityCards
          .map(cardToString)
          .map(c => '<span class="pill">' + escapeHtml(c) + '</span>')
          .join('');
      } else {
        boardCardsSpan.innerHTML = '<small>—</small>';
      }

      if (!state.players || state.players.length === 0) {
        playersList.innerHTML = '<small>Нет подключений.</small>';
      } else {
        playersList.innerHTML = state.players.map(p => {
          const isButton = state.buttonPlayerId && state.buttonPlayerId === p.id;
          const btn = isButton ? '<span class="pill pill-btn">BTN</span> ' : '';
          const pausedLabel = p.isPaused ? ' (на паузе)' : '';
          const rowStyle = p.isPaused ? 'opacity:0.5;' : '';
          const inHandLabel = p.inHand ? ' (в игре)' : '';
          return `
            <div class="player-row" style="${rowStyle}">
              <div class="player-main">
                <span>${btn}${escapeHtml(p.name || p.id)}${pausedLabel}</span>
                <span>${p.stack} фишек${inHandLabel}</span>
              </div>
              <small>Ставка в этом раунде: ${p.betThisStreet || 0}</small>
            </div>
          `;
        }).join('');
      }

      yourStackSpan.textContent = '—';
      yourCardsDiv.innerHTML = '<small>—</small>';
      yourMessageDiv.textContent = '';

      let me = null;
      if (state.players && state.players.length > 0 && socket && socket.id) {
        me = state.players.find(p => p.id === socket.id);
      }

      if (me) {
        yourStackSpan.textContent = me.stack;
        if (state.yourCards && state.yourCards.length > 0) {
          yourCardsDiv.innerHTML = state.yourCards
            .map(cardToString)
            .map(c => '<span class="pill">' + escapeHtml(c) + '</span>')
            .join('');
        }
        if (state.message) {
          yourMessageDiv.textContent = state.message;
        }
      }

      if (me) {
        playPauseBtn.disabled = false;
        playPauseBtn.textContent = me.isPaused ? 'Играть' : 'Пауза';
      } else {
        playPauseBtn.disabled = true;
        playPauseBtn.textContent = 'Пауза';
      }

      const isMyTurn = !!state.yourTurn;
      const stage = state.stage;
      const currentBet = state.currentBet || 0;
      const myBet = me ? (me.betThisStreet || 0) : 0;
      const canAct = isMyTurn && me && me.inHand && !me.isPaused && !['waiting', 'showdown'].includes(stage);

      foldBtn.disabled = !canAct;
      callBtn.disabled = !canAct;
      betBtn.disabled = !canAct;

      // управление таймером хода — только для текущего игрока
      if (me && state.yourTurn && state.turnDeadline) {
        startTurnCountdown(state.turnDeadline);
      } else {
        stopTurnCountdown();
      }

      if (!canAct) {
        if (stage !== 'waiting' && stage !== 'showdown' && currentPlayerName) {
          hintBox.textContent = 'Ход за игроком ' + currentPlayerName;
        } else if (stage === 'showdown') {
          hintBox.textContent = 'Раздача завершена (шоудаун / победа без вскрытия)';
        } else {
          hintBox.textContent = '';
        }
        return;
      }

      const toCall = currentBet - myBet;
      if (toCall <= 0) {
        callBtn.textContent = 'Чек';
        betBtn.textContent = 'Бет 10';
        hintBox.textContent = 'Ваш ход. Можно чекнуть или поставить 10.';
      } else {
        callBtn.textContent = 'Колл ' + toCall;
        betBtn.textContent = 'Рейз до ' + (currentBet + 10);
        hintBox.textContent = 'Ваш ход. Для колла нужно докинуть ' + toCall + ' фишек.';
      }
    }

    function cardToString(card) {
      if (!card) return '';
      if (typeof card === 'string') return card;
      const rank = card.rank || '?';
      const suit = card.suit || '';
      return String(rank) + String(suit);
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function(m) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[m];
      });
    }
  </script>
</body>
</html>
