<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Poker Demo Table</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Socket.IO клиент с сервера -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #111;
      color: #eee;
    }
    .card {
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      background: #1b1b1b;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    }
    h1 {
      font-size: 20px;
      margin-top: 0;
    }
    label, input, button {
      font-size: 14px;
    }
    input {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #000;
      color: #eee;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #2d8cff;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      background: #555;
      cursor: default;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .table-info, .players, .you {
      margin-top: 12px;
      padding: 8px;
      background: #111;
      border-radius: 8px;
      font-size: 13px;
    }
    .player-row {
      display: flex;
      flex-direction: column;
      padding: 4px 0;
      border-bottom: 1px solid #222;
    }
    .player-row:last-child {
      border-bottom: none;
    }
    .player-main {
      display: flex;
      justify-content: space-between;
    }
    small {
      color: #888;
    }
    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #222;
      margin-right: 4px;
      font-size: 12px;
    }
    .error {
      color: #ff6b6b;
      margin-top: 4px;
      font-size: 12px;
      min-height: 16px;
    }
    .hint {
      font-size: 12px;
      color: #aaa;
      margin-top: 4px;
      min-height: 14px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Poker Demo Table</h1>
    <p><small>Демо одного стола: подключение игроков, раздача карт, банк, стадии раздачи.</small></p>

    <label for="name">Ваш ник:</label>
    <input id="name" type="text" placeholder="Player" />

    <div class="row">
      <button id="joinBtn">Подключиться</button>
      <button id="leaveBtn" disabled>Отключиться</button>
    </div>

    <div class="row">
      <button id="startBtn" disabled>Начать раздачу</button>
      <button id="nextBtn" disabled>Следующая раздача (после шоудауна)</button>
    </div>

    <div class="row">
      <button id="foldBtn" disabled>Fold</button>
      <button id="callBtn" disabled>Check / Call</button>
      <button id="betBtn" disabled>Bet / Raise 10</button>
    </div>

    <div id="errorBox" class="error"></div>
    <div id="hintBox" class="hint"></div>

    <div class="table-info">
      <div><strong>Стадия:</strong> <span id="stage">waiting</span></div>
      <div><strong>Общий банк (пред. раунды):</strong> <span id="mainPot">0</span> фишек</div>
      <div><strong>Банк текущего раунда:</strong> <span id="streetPot">0</span> фишек</div>
      <div><strong>Суммарный банк:</strong> <span id="totalPot">0</span> фишек</div>
      <div><strong>Текущая ставка:</strong> <span id="currentBet">0</span></div>
      <div><strong>Блайнды:</strong> <span id="blinds">10 / 20</span></div>
      <div><strong>Ход игрока:</strong> <span id="currentTurn">—</span></div>
      <div style="margin-top:4px;">
        <strong>Борд:</strong>
        <span id="boardCards"><small>—</small></span>
      </div>
    </div>

    <div class="you">
      <strong>Ваши карты:</strong>
      <div id="yourCards"><small>—</small></div>
      <div><strong>Ваш стек:</strong> <span id="yourStack">—</span></div>
      <div id="yourMessage" style="margin-top:8px; color:#6df; font-size:14px; min-height:18px;"></div>
    </div>

    <div class="players">
      <strong>Игроки за столом:</strong>
      <div id="playersList">
        <small>Нет подключений.</small>
      </div>
    </div>
  </div>

  <script>
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const foldBtn = document.getElementById('foldBtn');
    const callBtn = document.getElementById('callBtn');
    const betBtn = document.getElementById('betBtn');
    const nameInput = document.getElementById('name');

    const errorBox = document.getElementById('errorBox');
    const hintBox = document.getElementById('hintBox');
    const stageSpan = document.getElementById('stage');
    const mainPotSpan = document.getElementById('mainPot');
    const streetPotSpan = document.getElementById('streetPot');
    const totalPotSpan = document.getElementById('totalPot');
    const currentBetSpan = document.getElementById('currentBet');
    const blindsSpan = document.getElementById('blinds');
    const currentTurnSpan = document.getElementById('currentTurn');
    const boardCardsSpan = document.getElementById('boardCards');
    const yourCardsDiv = document.getElementById('yourCards');
    const yourStackSpan = document.getElementById('yourStack');
    const yourMessageDiv = document.getElementById('yourMessage');
    const playersList = document.getElementById('playersList');

    const socket = io();
    console.log('Socket.io init');

    socket.on('connect', () => {
      console.log('Connected, id=', socket.id);
      errorBox.textContent = 'Подключен к серверу';
    });

    socket.on('disconnect', () => {
      console.log('Disconnected');
      errorBox.textContent = 'Отключен от сервера';
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      startBtn.disabled = true;
      nextBtn.disabled = true;
      foldBtn.disabled = true;
      callBtn.disabled = true;
      betBtn.disabled = true;
    });

    socket.on('gameState', (state) => {
      console.log('gameState:', state);
      renderState(state);
    });

    socket.on('errorMessage', (data) => {
      if (data && data.message) {
        errorBox.textContent = 'Ошибка: ' + data.message;
      }
    });

    joinBtn.addEventListener('click', () => {
      const name = nameInput.value.trim() || 'Player';
      errorBox.textContent = 'Подключаемся к столу...';
      socket.emit('joinTable', { playerName: name });
      joinBtn.disabled = true;
      leaveBtn.disabled = false;
      startBtn.disabled = false;
      nextBtn.disabled = false;
    });

    leaveBtn.addEventListener('click', () => {
      socket.disconnect();
      errorBox.textContent = '';
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      startBtn.disabled = true;
      nextBtn.disabled = true;
      foldBtn.disabled = true;
      callBtn.disabled = true;
      betBtn.disabled = true;
    });

    startBtn.addEventListener('click', () => {
      errorBox.textContent = '';
      socket.emit('startHand');
    });

    nextBtn.addEventListener('click', () => {
      errorBox.textContent = '';
      socket.emit('nextStage');
    });

    foldBtn.addEventListener('click', () => {
      errorBox.textContent = '';
      socket.emit('action', { type: 'fold' });
    });

    callBtn.addEventListener('click', () => {
      errorBox.textContent = '';
      socket.emit('action', { type: 'call' });
    });

    betBtn.addEventListener('click', () => {
      errorBox.textContent = '';
      socket.emit('action', { type: 'bet' });
    });

    function renderState(state) {
      if (!state) return;

      stageSpan.textContent = state.stage || 'waiting';
      mainPotSpan.textContent = state.mainPot != null ? state.mainPot : 0;
      streetPotSpan.textContent = state.streetPot != null ? state.streetPot : 0;
      totalPotSpan.textContent = state.totalPot != null ? state.totalPot : 0;
      currentBetSpan.textContent = state.currentBet != null ? state.currentBet : 0;
      blindsSpan.textContent = (state.smallBlind || 0) + ' / ' + (state.bigBlind || 0);

      // текущий ход
      if (state.currentTurn && state.players) {
        const current = state.players.find(p => p.id === state.currentTurn);
        currentTurnSpan.textContent = current ? (current.name || current.id) : '—';
      } else {
        currentTurnSpan.textContent = '—';
      }

      // борд
      if (state.communityCards && state.communityCards.length > 0) {
        boardCardsSpan.innerHTML = state.communityCards
          .map(cardToString)
          .map(c => '<span class="pill">' + escapeHtml(c) + '</span>')
          .join('');
      } else {
        boardCardsSpan.innerHTML = '<small>—</small>';
      }

      // список игроков
      if (!state.players || state.players.length === 0) {
        playersList.innerHTML = '<small>Нет подключений.</small>';
      } else {
        playersList.innerHTML = state.players.map(p => {
          return `
            <div class="player-row">
              <div class="player-main">
                <span>#${escapeHtml(p.id)} ${escapeHtml(p.name || '')}</span>
                <span>${p.stack} фишек${p.inHand ? ' (в игре)' : ''}</span>
              </div>
              <small>Ставка в этом раунде: ${p.betThisStreet || 0}</small>
            </div>
          `;
        }).join('');
      }

      // свои карты / стек / сообщения
      yourStackSpan.textContent = '—';
      yourCardsDiv.innerHTML = '<small>—</small>';
      yourMessageDiv.textContent = '';
      hintBox.textContent = '';

      let me = null;
      if (state.players && state.players.length > 0 && socket.id) {
        me = state.players.find(p => p.id === socket.id);
      }

      if (me) {
        yourStackSpan.textContent = me.stack;
        if (state.yourCards && state.yourCards.length > 0) {
          yourCardsDiv.innerHTML = state.yourCards
            .map(cardToString)
            .map(c => '<span class="pill">' + escapeHtml(c) + '</span>')
            .join('');
        }
      }

      const isMyTurn = !!(state.yourTurn);
      const stage = state.stage;
      const currentBet = state.currentBet || 0;
      const myBet = me ? (me.betThisStreet || 0) : 0;

      // подсказка / сообщение
      if (state.message) {
        yourMessageDiv.textContent = state.message;
      } else if (isMyTurn && stage !== 'showdown' && stage !== 'waiting' && me && me.inHand) {
        yourMessageDiv.textContent = 'Ваш ход';
      } else {
        yourMessageDiv.textContent = '';
      }

      const canAct = isMyTurn && me && me.inHand && !['waiting', 'showdown'].includes(stage);
      foldBtn.disabled = !canAct;
      callBtn.disabled = !canAct;
      betBtn.disabled = !canAct;

      if (!canAct) {
        hintBox.textContent = '';
        return;
      }

      // логика подписей кнопок:
      if (currentBet === 0) {
        // ещё никто не ставил: можно чекнуть или поставить
        callBtn.textContent = 'Check';
        betBtn.textContent = 'Bet 10';
        hintBox.textContent = 'Ставок в этом раунде нет: можете Check или Bet 10.';
      } else {
        const diff = currentBet - myBet;
        if (diff <= 0) {
          // вы уже уравняли: можно чекнуть (пропуск) или рейзнуть
          callBtn.textContent = 'Check';
          betBtn.textContent = 'Raise 10';
          hintBox.textContent = 'Вы уже уравняли ставку: можете Check или Raise 10.';
        } else {
          // вы позади: нужно докинуть diff для колла или сделать рейз
          callBtn.textContent = 'Call ' + diff;
          betBtn.textContent = 'Raise 10';
          hintBox.textContent = 'Для колла нужно докинуть: ' + diff + '. Можно Call или Raise 10.';
        }
      }
    }

    function cardToString(card) {
      if (!card) return '';
      if (typeof card === 'string') return card;
      const rank = card.rank || '?';
      const suit = card.suit || '';
      return String(rank) + String(suit);
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function(m) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[m];
      });
    }
  </script>
</body>
</html>
